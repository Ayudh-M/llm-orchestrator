\
#!/bin/bash
#SBATCH --job-name=consensus-hf
#SBATCH --partition=gpu_h100
#SBATCH --nodes=1
#SBATCH --gpus=1
#SBATCH --cpus-per-task=8
#SBATCH --time=00:10:00
#SBATCH --mem=40G
#SBATCH --output=logs/%x-%j.out

set -euo pipefail

TASK="${1:?task text required}"
ROLESET="${2:?roleset json path required}"
STRATEGY="${3:-S1}"
MODEL_A="${4:-mistralai/Mistral-7B-v0.1}"
MODEL_B="${5:-mistralai/Mistral-7B-v0.1}"
DTYPE="${6:-bfloat16}"

module purge
module load 2024
module load Python/3.12.3-GCCcore-13.3.0

if [ -f "$HOME/.venvs/consensus312/bin/activate" ]; then
  source "$HOME/.venvs/consensus312/bin/activate"
fi

if [ -d "/scratch-shared/$USER" ]; then
  export HF_HOME="/scratch-shared/$USER/hf-cache"
  mkdir -p "$HF_HOME"
fi

python -m src.main "$TASK" "$ROLESET" "$STRATEGY" "$MODEL_A" "$MODEL_B" "$DTYPE"
